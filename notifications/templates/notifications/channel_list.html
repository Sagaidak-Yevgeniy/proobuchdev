{% extends 'base.html' %}
{% load static %}

{% block title %}Каналы уведомлений{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 sm:py-8">
    <div class="max-w-3xl mx-auto">
        <h1 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6">Управление каналами уведомлений</h1>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 sm:p-6 mb-6 sm:mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                <!-- Email-уведомления -->
                <div class="p-3 sm:p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 sm:gap-0 mb-3 sm:mb-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-500 dark:text-blue-300 mr-3">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div>
                                <h3 class="text-sm sm:text-base font-semibold text-gray-800 dark:text-gray-200">Email-уведомления</h3>
                                <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">Получайте уведомления на почту</p>
                            </div>
                        </div>
                        <div class="relative inline-block w-12 mr-0 sm:mr-2 align-middle select-none">
                            <input type="checkbox" id="toggle-email" class="toggle-checkbox" 
                                   {% if email_notifications %}checked{% endif %}
                                   data-url="{% url 'notifications:toggle_channel' 'email' %}">
                            <label for="toggle-email" class="toggle-label"></label>
                        </div>
                    </div>
                    <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">
                        Получайте важные уведомления на ваш email. Вы можете настроить отправку 
                        в виде отдельных писем или ежедневного дайджеста.
                    </p>
                </div>
                
                <!-- Push-уведомления -->
                <div class="p-3 sm:p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 sm:gap-0 mb-3 sm:mb-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center text-green-500 dark:text-green-300 mr-3">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div>
                                <h3 class="text-sm sm:text-base font-semibold text-gray-800 dark:text-gray-200">Push-уведомления</h3>
                                <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">Мгновенные оповещения на устройствах</p>
                            </div>
                        </div>
                        <div class="relative inline-block w-12 mr-0 sm:mr-2 align-middle select-none">
                            <input type="checkbox" id="toggle-push" class="toggle-checkbox" 
                                   {% if push_notifications %}checked{% endif %}
                                   data-url="{% url 'notifications:toggle_channel' 'push' %}">
                            <label for="toggle-push" class="toggle-label"></label>
                        </div>
                    </div>
                    <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">
                        Получайте мгновенные уведомления на ваших устройствах, даже когда вы 
                        не находитесь на сайте.
                        <a href="{% url 'notifications:device_list' %}" class="text-blue-500 hover:underline">Управление устройствами</a>
                    </p>
                </div>
                
                <!-- Дополнительные каналы -->
                {% for channel in channels %}
                    <div class="p-3 sm:p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 sm:gap-0 mb-3 sm:mb-4">
                            <div class="flex items-center">
                                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center text-purple-500 dark:text-purple-300 mr-3">
                                    <i class="fas fa-{{ channel.icon|default:'comment' }}"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm sm:text-base font-semibold text-gray-800 dark:text-gray-200">{{ channel.name }}</h3>
                                    <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">{{ channel.description }}</p>
                                </div>
                            </div>
                            <div class="relative inline-block w-12 mr-0 sm:mr-2 align-middle select-none">
                                <input type="checkbox" id="toggle-{{ channel.id }}" class="toggle-checkbox" 
                                       {% if channel.id in preferred_channels %}checked{% endif %}
                                       data-url="{% url 'notifications:toggle_channel' channel.channel_type %}">
                                <label for="toggle-{{ channel.id }}" class="toggle-label"></label>
                            </div>
                        </div>
                        <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">
                            {{ channel.long_description|default:channel.description }}
                        </p>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 sm:p-6">
            <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4">Тихие часы</h2>
            
            <div class="mb-4">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 sm:gap-0">
                    <div>
                        <h3 class="text-sm sm:text-base font-medium text-gray-700 dark:text-gray-300">Включить тихие часы</h3>
                        <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">В указанное время уведомления не будут вас беспокоить</p>
                    </div>
                    <div class="relative inline-block w-12 mr-0 sm:mr-2 align-middle select-none">
                        <input type="checkbox" id="toggle-quiet-hours" class="toggle-checkbox" 
                               {% if quiet_hours_enabled %}checked{% endif %}
                               data-url="{% url 'notifications:toggle_quiet_hours' %}">
                        <label for="toggle-quiet-hours" class="toggle-label"></label>
                    </div>
                </div>
            </div>
            
            <form action="{% url 'notifications:update_quiet_hours' %}" method="post" class="space-y-4" id="quietHoursForm">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Начало тихих часов
                        </label>
                        <input type="time" name="start_time" value="{{ quiet_hours_start|date:'H:i' }}" 
                               class="form-input w-full text-sm" required>
                    </div>
                    
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Окончание тихих часов
                        </label>
                        <input type="time" name="end_time" value="{{ quiet_hours_end|date:'H:i' }}" 
                               class="form-input w-full text-sm" required>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button type="submit" class="btn-primary text-sm sm:text-base w-full sm:w-auto">
                        <i class="fas fa-save mr-2"></i> Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик переключения каналов
    document.querySelectorAll('.toggle-checkbox').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const url = this.dataset.url;
            const checkbox = this;
            
            // Отправляем AJAX-запрос для переключения канала
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Ошибка:', data.error);
                    checkbox.checked = !checkbox.checked; // Возвращаем в исходное состояние
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                checkbox.checked = !checkbox.checked; // Возвращаем в исходное состояние
            });
        });
    });
    
    // Получение CSRF-токена
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
});
</script>
{% endblock %}