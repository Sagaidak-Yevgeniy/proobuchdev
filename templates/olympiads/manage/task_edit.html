{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% trans 'Редактирование задания' %} | {{ task.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-6 flex items-center">
        <a href="{% url 'olympiads:olympiad_edit' olympiad_id=olympiad.id %}" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-3">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
            {% trans 'Редактирование задания' %}: {{ task.title }}
        </h1>
    </div>
    
    <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg mb-6">
        <form method="post" action="{% url 'olympiads:olympiad_task_edit' olympiad_id=olympiad.id task_id=task.id %}">
            {% csrf_token %}
            
            <div class="px-4 py-5 sm:p-6 space-y-6">
                <fieldset class="space-y-4">
                    <legend class="text-lg font-medium text-gray-900 dark:text-white">{% trans 'Основная информация' %}</legend>
                    
                    <div>
                        <label for="id_title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Название' %} *</label>
                        <input type="text" name="title" id="id_title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="{{ task.title }}" required>
                    </div>
                    
                    <div>
                        <label for="id_description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Описание' %} *</label>
                        <textarea name="description" id="id_description" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400" required>{{ task.description }}</textarea>
                    </div>
                    
                    <div>
                        <label for="id_points" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Баллы' %} *</label>
                        <input type="number" name="points" id="id_points" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="{{ task.points }}" min="1" required>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{% trans 'Количество баллов за правильное решение' %}</p>
                    </div>
                    
                    <div>
                        <label for="id_order" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Порядок отображения' %}</label>
                        <input type="number" name="order" id="id_order" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="{{ task.order }}" min="1">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{% trans 'Порядок отображения задания в списке (меньшие значения отображаются первыми)' %}</p>
                    </div>
                </fieldset>
                
                {% if task.task_type == 'PROGRAMMING' %}
                <fieldset class="space-y-4">
                    <legend class="text-lg font-medium text-gray-900 dark:text-white">{% trans 'Задание на программирование' %}</legend>
                    
                    <div>
                        <label for="id_initial_code" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Начальный код' %}</label>
                        <textarea name="initial_code" id="id_initial_code" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 font-mono">{{ task.initial_code }}</textarea>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{% trans 'Код, который будет отображаться в редакторе изначально' %}</p>
                    </div>
                </fieldset>
                {% endif %}
                
                {% if task.task_type == 'MULTIPLE_CHOICE' %}
                <fieldset class="space-y-4">
                    <legend class="flex justify-between items-center">
                        <span class="text-lg font-medium text-gray-900 dark:text-white">{% trans 'Варианты ответов' %}</span>
                        <button type="button" id="add-option" class="px-2 py-1 border border-blue-500 rounded-md text-xs font-medium text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-blue-600 dark:text-blue-400 dark:hover:bg-gray-600">
                            <i class="fas fa-plus mr-1"></i> {% trans 'Добавить вариант' %}
                        </button>
                    </legend>
                    
                    <div id="options-container">
                        {% if options %}
                            {% for option in options %}
                            <div class="option-item bg-gray-50 dark:bg-gray-700 p-4 rounded-md mb-3">
                                <div class="flex items-start mb-3">
                                    <div class="flex items-center h-5">
                                        <input type="checkbox" name="is_correct_{{ option.id }}" id="is_correct_{{ option.id }}" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600" {% if option.is_correct %}checked{% endif %}>
                                    </div>
                                    <div class="ml-3 text-sm">
                                        <label for="is_correct_{{ option.id }}" class="font-medium text-gray-700 dark:text-gray-300">{% trans 'Правильный ответ' %}</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="option_text_{{ option.id }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Текст варианта' %}</label>
                                    <input type="text" name="option_text_{{ option.id }}" id="option_text_{{ option.id }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="{{ option.text }}">
                                </div>
                                
                                <div class="flex justify-end">
                                    <button type="button" class="delete-option px-2 py-1 border border-red-300 rounded-md text-xs font-medium text-red-600 bg-white hover:bg-red-50 focus:outline-none dark:bg-gray-700 dark:border-red-500 dark:text-red-400 dark:hover:bg-gray-600" data-id="{{ option.id }}">
                                        <i class="fas fa-trash-alt mr-1"></i> {% trans 'Удалить' %}
                                    </button>
                                </div>
                                
                                <input type="hidden" name="option_id_{{ option.id }}" value="{{ option.id }}">
                                <input type="hidden" name="option_order_{{ option.id }}" value="{{ option.order }}">
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-500 dark:text-gray-400">{% trans 'Нет вариантов ответа. Добавьте хотя бы один вариант.' %}</p>
                        {% endif %}
                    </div>
                    
                    <template id="option-template">
                        <div class="option-item bg-gray-50 dark:bg-gray-700 p-4 rounded-md mb-3">
                            <div class="flex items-start mb-3">
                                <div class="flex items-center h-5">
                                    <input type="checkbox" name="new_is_correct_%id%" id="new_is_correct_%id%" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="new_is_correct_%id%" class="font-medium text-gray-700 dark:text-gray-300">{% trans 'Правильный ответ' %}</label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="new_option_text_%id%" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Текст варианта' %}</label>
                                <input type="text" name="new_option_text_%id%" id="new_option_text_%id%" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            
                            <div class="flex justify-end">
                                <button type="button" class="delete-new-option px-2 py-1 border border-red-300 rounded-md text-xs font-medium text-red-600 bg-white hover:bg-red-50 focus:outline-none dark:bg-gray-700 dark:border-red-500 dark:text-red-400 dark:hover:bg-gray-600" data-id="%id%">
                                    <i class="fas fa-trash-alt mr-1"></i> {% trans 'Удалить' %}
                                </button>
                            </div>
                            
                            <input type="hidden" name="new_option_id_%id%" value="%id%">
                            <input type="hidden" name="new_option_order_%id%" value="10">
                        </div>
                    </template>
                    
                    <input type="hidden" name="deleted_options" id="deleted-options" value="">
                    <input type="hidden" name="new_options_count" id="new-options-count" value="0">
                </fieldset>
                {% endif %}
            </div>
            
            <div class="px-4 py-3 bg-gray-50 dark:bg-gray-700 text-right sm:px-6">
                <a href="{% url 'olympiads:olympiad_edit' olympiad_id=olympiad.id %}" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600 mr-2">
                    {% trans 'Отмена' %}
                </a>
                <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-800 dark:hover:bg-blue-700">
                    {% trans 'Сохранить изменения' %}
                </button>
            </div>
        </form>
    </div>
    
    {% if task.task_type == 'PROGRAMMING' %}
    <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <div>
                <h2 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                    {% trans 'Тестовые случаи' %}
                </h2>
                <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
                    {% trans 'Используются для автоматической проверки заданий на программирование' %}
                </p>
            </div>
            <button type="button" id="add-test-case" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-800 dark:hover:bg-blue-700">
                <i class="fas fa-plus mr-2"></i> {% trans 'Добавить тест' %}
            </button>
        </div>
        
        <div class="px-4 py-5 sm:p-6">
            <form id="test-cases-form" method="post" action="#" class="space-y-6">
                {% csrf_token %}
                
                <div id="test-cases-container">
                    {% if test_cases %}
                        {% for test_case in test_cases %}
                        <div class="test-case-item bg-gray-50 dark:bg-gray-700 p-4 rounded-md mb-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-md font-medium text-gray-900 dark:text-white">{% trans 'Тест' %} #{{ forloop.counter }}</h3>
                                <div class="flex items-center">
                                    <div class="flex items-center mr-4">
                                        <input type="checkbox" id="is_hidden_{{ test_case.id }}" name="is_hidden_{{ test_case.id }}" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600" {% if test_case.is_hidden %}checked{% endif %}>
                                        <label for="is_hidden_{{ test_case.id }}" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                                            {% trans 'Скрытый тест' %}
                                        </label>
                                    </div>
                                    <button type="button" class="delete-test-case px-2 py-1 border border-red-300 rounded-md text-xs font-medium text-red-600 bg-white hover:bg-red-50 focus:outline-none dark:bg-gray-700 dark:border-red-500 dark:text-red-400 dark:hover:bg-gray-600" data-id="{{ test_case.id }}">
                                        <i class="fas fa-trash-alt mr-1"></i> {% trans 'Удалить' %}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="input_data_{{ test_case.id }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Входные данные' %}</label>
                                    <textarea name="input_data_{{ test_case.id }}" id="input_data_{{ test_case.id }}" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 font-mono">{{ test_case.input_data }}</textarea>
                                </div>
                                
                                <div>
                                    <label for="expected_output_{{ test_case.id }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Ожидаемый результат' %}</label>
                                    <textarea name="expected_output_{{ test_case.id }}" id="expected_output_{{ test_case.id }}" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 font-mono">{{ test_case.expected_output }}</textarea>
                                </div>
                            </div>
                            
                            <input type="hidden" name="test_case_id_{{ test_case.id }}" value="{{ test_case.id }}">
                            <input type="hidden" name="test_case_order_{{ test_case.id }}" value="{{ test_case.order }}">
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-500 dark:text-gray-400">{% trans 'Нет тестовых случаев. Добавьте хотя бы один тест.' %}</p>
                    {% endif %}
                </div>
                
                <template id="test-case-template">
                    <div class="test-case-item bg-gray-50 dark:bg-gray-700 p-4 rounded-md mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-md font-medium text-gray-900 dark:text-white">{% trans 'Новый тест' %}</h3>
                            <div class="flex items-center">
                                <div class="flex items-center mr-4">
                                    <input type="checkbox" id="new_is_hidden_%id%" name="new_is_hidden_%id%" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600">
                                    <label for="new_is_hidden_%id%" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                                        {% trans 'Скрытый тест' %}
                                    </label>
                                </div>
                                <button type="button" class="delete-new-test-case px-2 py-1 border border-red-300 rounded-md text-xs font-medium text-red-600 bg-white hover:bg-red-50 focus:outline-none dark:bg-gray-700 dark:border-red-500 dark:text-red-400 dark:hover:bg-gray-600" data-id="%id%">
                                    <i class="fas fa-trash-alt mr-1"></i> {% trans 'Удалить' %}
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="new_input_data_%id%" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Входные данные' %}</label>
                                <textarea name="new_input_data_%id%" id="new_input_data_%id%" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 font-mono"></textarea>
                            </div>
                            
                            <div>
                                <label for="new_expected_output_%id%" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{% trans 'Ожидаемый результат' %}</label>
                                <textarea name="new_expected_output_%id%" id="new_expected_output_%id%" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 font-mono"></textarea>
                            </div>
                        </div>
                        
                        <input type="hidden" name="new_test_case_id_%id%" value="%id%">
                        <input type="hidden" name="new_test_case_order_%id%" value="10">
                    </div>
                </template>
                
                <input type="hidden" name="deleted_test_cases" id="deleted-test-cases" value="">
                <input type="hidden" name="new_test_cases_count" id="new-test-cases-count" value="0">
                
                <div class="flex justify-end">
                    <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-800 dark:hover:bg-blue-700">
                        {% trans 'Сохранить тесты' %}
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

{% if task.task_type == 'MULTIPLE_CHOICE' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addOptionBtn = document.getElementById('add-option');
    const optionsContainer = document.getElementById('options-container');
    const optionTemplate = document.getElementById('option-template').innerHTML;
    const deletedOptionsInput = document.getElementById('deleted-options');
    const newOptionsCountInput = document.getElementById('new-options-count');
    
    let newOptionId = 1;
    
    // Добавление нового варианта
    addOptionBtn.addEventListener('click', function() {
        const newOption = optionTemplate.replace(/%id%/g, newOptionId);
        optionsContainer.insertAdjacentHTML('beforeend', newOption);
        
        // Обновляем счетчик новых вариантов
        newOptionsCountInput.value = newOptionId;
        
        // Увеличиваем счетчик
        newOptionId++;
    });
    
    // Удаление существующего варианта
    optionsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-option') || e.target.closest('.delete-option')) {
            const button = e.target.classList.contains('delete-option') ? e.target : e.target.closest('.delete-option');
            const optionId = button.dataset.id;
            const optionItem = button.closest('.option-item');
            
            // Добавляем ID в список удаленных
            const deletedIds = deletedOptionsInput.value ? deletedOptionsInput.value.split(',') : [];
            deletedIds.push(optionId);
            deletedOptionsInput.value = deletedIds.join(',');
            
            // Удаляем элемент из DOM
            optionItem.remove();
        }
        
        // Удаление нового варианта
        if (e.target.classList.contains('delete-new-option') || e.target.closest('.delete-new-option')) {
            const button = e.target.classList.contains('delete-new-option') ? e.target : e.target.closest('.delete-new-option');
            const optionItem = button.closest('.option-item');
            
            // Просто удаляем элемент из DOM
            optionItem.remove();
        }
    });
});
</script>
{% endif %}

{% if task.task_type == 'PROGRAMMING' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addTestCaseBtn = document.getElementById('add-test-case');
    const testCasesContainer = document.getElementById('test-cases-container');
    const testCaseTemplate = document.getElementById('test-case-template').innerHTML;
    const deletedTestCasesInput = document.getElementById('deleted-test-cases');
    const newTestCasesCountInput = document.getElementById('new-test-cases-count');
    const testCasesForm = document.getElementById('test-cases-form');
    
    let newTestCaseId = 1;
    
    // Добавление нового тестового случая
    addTestCaseBtn.addEventListener('click', function() {
        const newTestCase = testCaseTemplate.replace(/%id%/g, newTestCaseId);
        testCasesContainer.insertAdjacentHTML('beforeend', newTestCase);
        
        // Обновляем счетчик новых тестов
        newTestCasesCountInput.value = newTestCaseId;
        
        // Увеличиваем счетчик
        newTestCaseId++;
    });
    
    // Удаление тестового случая
    testCasesContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-test-case') || e.target.closest('.delete-test-case')) {
            const button = e.target.classList.contains('delete-test-case') ? e.target : e.target.closest('.delete-test-case');
            const testCaseId = button.dataset.id;
            const testCaseItem = button.closest('.test-case-item');
            
            // Добавляем ID в список удаленных
            const deletedIds = deletedTestCasesInput.value ? deletedTestCasesInput.value.split(',') : [];
            deletedIds.push(testCaseId);
            deletedTestCasesInput.value = deletedIds.join(',');
            
            // Удаляем элемент из DOM
            testCaseItem.remove();
        }
        
        // Удаление нового тестового случая
        if (e.target.classList.contains('delete-new-test-case') || e.target.closest('.delete-new-test-case')) {
            const button = e.target.classList.contains('delete-new-test-case') ? e.target : e.target.closest('.delete-new-test-case');
            const testCaseItem = button.closest('.test-case-item');
            
            // Просто удаляем элемент из DOM
            testCaseItem.remove();
        }
    });
    
    // Отправка формы с тестами
    testCasesForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Здесь будет AJAX-запрос для сохранения тестов
        // Пока просто показываем уведомление
        showNotification('Сохранение тестов будет реализовано в следующей версии', 'info');
    });
});
</script>
{% endif %}
{% endblock %}