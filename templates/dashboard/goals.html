{% extends 'base.html' %}
{% load static %}

{% block title %}Цели обучения{% endblock %}

{% block extra_css %}
<style>
    /* Общие стили для целей */
    .goal-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .goal-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .progress-bar {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        background-color: #e2e8f0;
    }
    .progress-bar-inner {
        height: 100%;
        transition: width 0.5s ease;
    }
    /* Стили для приоритетов */
    .priority-high {
        background-color: #FEE2E2;
        border-color: #FCA5A5;
        color: #B91C1C;
    }
    .priority-medium {
        background-color: #FEF3C7;
        border-color: #FCD34D;
        color: #92400E;
    }
    .priority-low {
        background-color: #DBEAFE;
        border-color: #93C5FD;
        color: #1E40AF;
    }
    .priority-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        font-weight: 600;
    }
    /* Стили для фильтров */
    .filter-button.active {
        background-color: #4299e1;
        color: white;
    }
    .filter-button:hover:not(.active) {
        background-color: #e2e8f0;
    }
    /* Анимация для карточек */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
        animation: fadeIn 0.4s ease-out forwards;
    }
    /* Стили для модального окна */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    .modal.active {
        opacity: 1;
        pointer-events: auto;
    }
    .modal-content {
        background-color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        width: 90%;
        max-width: 750px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }
    .modal.active .modal-content {
        transform: scale(1);
    }
    /* Чекбокс стилизованный */
    .custom-checkbox input[type="checkbox"] {
        display: none;
    }
    .custom-checkbox label {
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .custom-checkbox label::before {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid #4299e1;
        border-radius: 4px;
        margin-right: 10px;
        display: inline-block;
        transition: background-color 0.2s, border-color 0.2s;
    }
    .custom-checkbox input[type="checkbox"]:checked + label::before {
        background-color: #4299e1;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff'%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z'/%3E%3C/svg%3E");
        background-size: 16px;
        background-position: center;
        background-repeat: no-repeat;
    }
    /* Состояние перетаскивания для шагов */
    .step-item.dragging {
        opacity: 0.5;
        background-color: #f3f4f6;
    }
    .step-item.drag-over {
        border-top: 2px dashed #4299e1;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold mb-2 text-gray-800 dark:text-white">Цели обучения</h1>
            <p class="text-gray-600 dark:text-gray-300">Отслеживайте свой прогресс и достигайте новых высот</p>
        </div>
        <div>
            <button id="createGoalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors shadow-md flex items-center">
                <i class="fas fa-plus mr-2"></i>Добавить цель
            </button>
        </div>
    </div>

    <!-- Фильтры и статистика -->
    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h3 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Фильтровать по:</h3>
                <div class="flex flex-wrap gap-2">
                    <button class="filter-button active py-1.5 px-3 rounded-md text-sm font-medium transition-colors" data-filter="all">Все</button>
                    <button class="filter-button py-1.5 px-3 rounded-md text-sm font-medium transition-colors" data-filter="active">Активные</button>
                    <button class="filter-button py-1.5 px-3 rounded-md text-sm font-medium transition-colors" data-filter="completed">Завершенные</button>
                    <button class="filter-button py-1.5 px-3 rounded-md text-sm font-medium transition-colors" data-filter="high">Высокий приоритет</button>
                    <button class="filter-button py-1.5 px-3 rounded-md text-sm font-medium transition-colors" data-filter="course">Связанные с курсами</button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white dark:bg-gray-800 p-3 rounded-md shadow-sm text-center">
                    <div class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-1" id="goals-stats-total">0</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Всего целей</div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-3 rounded-md shadow-sm text-center">
                    <div class="text-3xl font-bold text-green-600 dark:text-green-400 mb-1" id="goals-stats-completed">0</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Завершено</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Список целей -->
    <div id="goals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Сюда будут добавляться карточки целей через JavaScript -->
        <div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400">
            <div class="animate-spin w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p>Загрузка целей...</p>
        </div>
    </div>
</div>

<!-- Шаблон для карточки цели -->
<template id="goal-card-template">
    <div class="goal-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden animate-fade-in" style="animation-delay: calc(var(--index) * 0.1s);">
        <div class="p-5">
            <div class="flex justify-between items-start mb-3">
                <h3 class="goal-title text-lg font-semibold text-gray-800 dark:text-white"></h3>
                <span class="goal-priority priority-badge"></span>
            </div>
            <p class="goal-description text-gray-600 dark:text-gray-300 text-sm mb-4 line-clamp-2"></p>
            
            <div class="mb-3">
                <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1">
                    <span>Прогресс</span>
                    <span class="goal-progress-percent">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-inner bg-blue-500"></div>
                </div>
            </div>
            
            <div class="flex justify-between items-center text-sm">
                <div class="flex items-center">
                    <i class="far fa-calendar-alt mr-1 text-gray-400"></i>
                    <span class="goal-due-date text-gray-600 dark:text-gray-300"></span>
                </div>
                <div class="goal-steps-counter text-gray-600 dark:text-gray-300"></div>
            </div>
        </div>
        <div class="px-5 py-3 border-t border-gray-100 dark:border-gray-700 flex justify-between">
            <button class="details-btn text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium">
                Подробнее
            </button>
            <button class="complete-btn text-sm font-medium"></button>
        </div>
    </div>
</template>

<!-- Модальное окно для добавления/редактирования цели -->
<div id="goal-modal" class="modal">
    <div class="modal-content dark:bg-gray-800">
        <div class="flex justify-between items-start mb-4">
            <h2 id="modal-title" class="text-xl font-bold text-gray-800 dark:text-white">Новая цель</h2>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="goal-form" class="space-y-4">
            <input type="hidden" id="goal-id">
            <div>
                <label for="goal-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Название цели</label>
                <input type="text" id="goal-title" name="title" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
                <label for="goal-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Описание (необязательно)</label>
                <textarea id="goal-description" name="description" rows="2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="goal-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Тип цели</label>
                    <select id="goal-type" name="goal_type" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="course">Прохождение курса</option>
                        <option value="exam">Подготовка к экзамену</option>
                        <option value="skill">Изучение навыка</option>
                        <option value="project">Выполнение проекта</option>
                        <option value="custom">Другое</option>
                    </select>
                </div>
                <div>
                    <label for="goal-priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Приоритет</label>
                    <select id="goal-priority" name="priority" required class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="high">Высокий</option>
                        <option value="medium" selected>Средний</option>
                        <option value="low">Низкий</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="goal-due-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Срок выполнения</label>
                    <input type="date" id="goal-due-date" name="due_date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label for="goal-course" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Связанный курс (опционально)</label>
                    <select id="goal-course" name="course" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Не связан с курсом</option>
                        <!-- Курсы будут добавлены через JavaScript -->
                    </select>
                </div>
            </div>
            
            <div>
                <h3 class="block text-base font-medium text-gray-700 dark:text-gray-300 mb-2">Шаги для достижения цели</h3>
                <div id="steps-container" class="space-y-2 mb-2">
                    <!-- Шаги будут добавляться сюда -->
                </div>
                <button type="button" id="add-step-btn" class="mt-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 hover:underline flex items-center text-sm">
                    <i class="fas fa-plus mr-1"></i> Добавить шаг
                </button>
            </div>
            
            <div class="flex justify-end pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" id="cancel-goal" class="mr-3 px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 font-medium">Отмена</button>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md transition-colors">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно для просмотра подробностей цели -->
<div id="goal-details-modal" class="modal">
    <div class="modal-content dark:bg-gray-800">
        <div class="flex justify-between items-start mb-4">
            <h2 id="detail-title" class="text-xl font-bold text-gray-800 dark:text-white"></h2>
            <button id="close-details-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="goal-details-content">
            <div class="flex justify-between items-center mb-4">
                <span id="detail-priority" class="priority-badge"></span>
                <span id="detail-status" class="text-sm px-3 py-1 rounded-full"></span>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Описание</h3>
                <p id="detail-description" class="text-gray-600 dark:text-gray-400 text-sm"></p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-md p-3">
                    <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Тип цели</h4>
                    <p id="detail-type" class="text-gray-800 dark:text-white"></p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-md p-3">
                    <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Срок выполнения</h4>
                    <p id="detail-due-date" class="text-gray-800 dark:text-white"></p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-md p-3">
                    <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Прогресс</h4>
                    <div class="flex items-center">
                        <div class="w-full mr-2">
                            <div class="progress-bar">
                                <div id="detail-progress-bar" class="progress-bar-inner bg-blue-500"></div>
                            </div>
                        </div>
                        <span id="detail-progress" class="text-gray-800 dark:text-white whitespace-nowrap"></span>
                    </div>
                </div>
            </div>
            
            <div id="detail-course-section" class="mb-6 hidden">
                <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Связанный курс</h3>
                <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-md flex items-center">
                    <i class="fas fa-book text-blue-500 mr-3"></i>
                    <div>
                        <h4 id="detail-course-title" class="font-medium text-gray-800 dark:text-white"></h4>
                        <a id="detail-course-link" href="#" class="text-blue-600 dark:text-blue-400 text-sm hover:underline">Перейти к курсу</a>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Шаги для достижения цели</h3>
                <div id="detail-steps-container" class="space-y-2">
                    <!-- Сюда будут добавляться шаги через JavaScript -->
                    <div class="text-gray-500 dark:text-gray-400 text-sm italic">Нет шагов для этой цели</div>
                </div>
            </div>
            
            <div class="flex justify-between border-t border-gray-200 dark:border-gray-700 pt-4">
                <div class="space-x-2">
                    <button id="detail-edit-btn" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 px-3 py-1 rounded border border-blue-500 text-sm font-medium">
                        <i class="fas fa-edit mr-1"></i>Редактировать
                    </button>
                    <button id="detail-delete-btn" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 px-3 py-1 rounded border border-red-500 text-sm font-medium">
                        <i class="fas fa-trash-alt mr-1"></i>Удалить
                    </button>
                </div>
                <button id="detail-complete-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-1 px-4 rounded-md transition-colors text-sm"></button>
            </div>
        </div>
    </div>
</div>

<!-- Шаблон для шага -->
<template id="step-template">
    <div class="step-item bg-gray-50 dark:bg-gray-700 rounded p-3 flex items-start">
        <input type="hidden" name="step_id" value="">
        <div class="flex-1">
            <input type="text" name="step_title" placeholder="Название шага" required class="w-full p-1 mb-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white text-sm">
            <textarea name="step_description" placeholder="Описание (необязательно)" rows="1" class="w-full p-1 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white text-sm"></textarea>
        </div>
        <div class="ml-3 pt-1 flex flex-col space-y-2">
            <button type="button" class="move-step-up text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button type="button" class="move-step-down text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <i class="fas fa-arrow-down"></i>
            </button>
            <button type="button" class="remove-step text-red-400 hover:text-red-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</template>

<!-- Шаблон для шага (просмотр деталей) -->
<template id="step-detail-template">
    <div class="step-detail-item bg-gray-50 dark:bg-gray-700 rounded p-3">
        <div class="flex items-center mb-2">
            <div class="custom-checkbox">
                <input type="checkbox" class="step-checkbox">
                <label class="step-checkbox-label">
                    <span class="step-title font-medium text-gray-800 dark:text-white"></span>
                </label>
            </div>
        </div>
        <p class="step-description text-sm text-gray-600 dark:text-gray-400 ml-8"></p>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const goalsContainer = document.getElementById('goals-container');
        const goalCardTemplate = document.getElementById('goal-card-template');
        const goalModal = document.getElementById('goal-modal');
        const detailsModal = document.getElementById('goal-details-modal');
        const goalForm = document.getElementById('goal-form');
        const createGoalBtn = document.getElementById('createGoalBtn');
        const filterButtons = document.querySelectorAll('.filter-button');
        const stepsContainer = document.getElementById('steps-container');
        const addStepBtn = document.getElementById('add-step-btn');
        const stepTemplate = document.getElementById('step-template');
        const stepDetailTemplate = document.getElementById('step-detail-template');
        
        let goals = [];
        let currentFilter = 'all';
        
        // Загрузка целей с сервера
        function loadGoals() {
            fetch('/dashboard/api/student-goals/')
                .then(response => response.json())
                .then(data => {
                    goals = data.goals;
                    renderGoals();
                    updateStats();
                })
                .catch(error => {
                    console.error('Ошибка загрузки целей:', error);
                    goalsContainer.innerHTML = `
                        <div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400">
                            <i class="fas fa-exclamation-circle text-3xl mb-3"></i>
                            <p>Не удалось загрузить цели. Пожалуйста, попробуйте позже.</p>
                        </div>
                    `;
                });
        }
        
        // Отображение целей
        function renderGoals() {
            goalsContainer.innerHTML = '';
            
            const filteredGoals = filterGoals(goals, currentFilter);
            
            if (filteredGoals.length === 0) {
                goalsContainer.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400">
                        <i class="fas fa-bullseye text-3xl mb-3"></i>
                        <p>У вас пока нет целей. Нажмите "Добавить цель", чтобы создать первую.</p>
                    </div>
                `;
                return;
            }
            
            filteredGoals.forEach((goal, index) => {
                const card = goalCardTemplate.content.cloneNode(true);
                const goalCard = card.querySelector('.goal-card');
                goalCard.dataset.goalId = goal.id;
                goalCard.style.setProperty('--index', index);
                
                // Заполняем данные цели
                card.querySelector('.goal-title').textContent = goal.title;
                card.querySelector('.goal-description').textContent = goal.description || 'Нет описания';
                
                // Прогресс
                const progressBar = card.querySelector('.progress-bar-inner');
                const progressPercent = card.querySelector('.goal-progress-percent');
                progressBar.style.width = `${goal.progress}%`;
                progressPercent.textContent = `${goal.progress}%`;
                
                // Дата выполнения
                const dueDate = card.querySelector('.goal-due-date');
                if (goal.due_date) {
                    dueDate.textContent = formatDate(goal.due_date);
                    
                    // Проверяем, не просрочена ли цель
                    if (isOverdue(goal.due_date) && !goal.is_completed) {
                        dueDate.classList.add('text-red-500', 'font-medium');
                        dueDate.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i>${dueDate.textContent} (просрочено)`;
                    }
                } else {
                    dueDate.textContent = 'Без срока';
                }
                
                // Приоритет
                const priorityBadge = card.querySelector('.goal-priority');
                setPriorityBadge(priorityBadge, goal.priority);
                
                // Счетчик шагов
                const stepsCounter = card.querySelector('.goal-steps-counter');
                if (goal.steps && goal.steps.length > 0) {
                    const completedSteps = goal.steps.filter(step => step.is_completed).length;
                    stepsCounter.textContent = `${completedSteps}/${goal.steps.length} шагов`;
                } else {
                    stepsCounter.textContent = 'Нет шагов';
                }
                
                // Кнопка завершения
                const completeBtn = card.querySelector('.complete-btn');
                if (goal.is_completed) {
                    completeBtn.textContent = 'Возобновить';
                    completeBtn.classList.add('text-yellow-600', 'hover:text-yellow-800');
                    completeBtn.dataset.action = 'reopen';
                    
                    // Добавляем метку "Завершено"
                    const completedBadge = document.createElement('div');
                    completedBadge.className = 'absolute top-3 left-3 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-md';
                    completedBadge.textContent = 'Завершено';
                    goalCard.classList.add('relative');
                    goalCard.prepend(completedBadge);
                } else {
                    completeBtn.textContent = 'Завершить';
                    completeBtn.classList.add('text-green-600', 'hover:text-green-800');
                    completeBtn.dataset.action = 'complete';
                }
                
                // Обработчики событий
                card.querySelector('.details-btn').addEventListener('click', () => showGoalDetails(goal.id));
                completeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = completeBtn.dataset.action;
                    
                    if (action === 'complete') {
                        completeGoal(goal.id);
                    } else if (action === 'reopen') {
                        reopenGoal(goal.id);
                    }
                });
                
                goalsContainer.appendChild(card);
            });
        }
        
        // Фильтрация целей
        function filterGoals(goals, filter) {
            if (filter === 'all') return goals;
            
            switch (filter) {
                case 'active':
                    return goals.filter(goal => !goal.is_completed);
                case 'completed':
                    return goals.filter(goal => goal.is_completed);
                case 'high':
                    return goals.filter(goal => goal.priority === 'high');
                case 'course':
                    return goals.filter(goal => goal.course);
                default:
                    return goals;
            }
        }
        
        // Обновление статистики
        function updateStats() {
            document.getElementById('goals-stats-total').textContent = goals.length;
            document.getElementById('goals-stats-completed').textContent = goals.filter(goal => goal.is_completed).length;
        }
        
        // Отображение приоритета
        function setPriorityBadge(element, priority) {
            element.className = 'priority-badge';
            
            switch (priority) {
                case 'high':
                    element.classList.add('priority-high');
                    element.innerHTML = '<i class="fas fa-arrow-up"></i> Высокий';
                    break;
                case 'medium':
                    element.classList.add('priority-medium');
                    element.innerHTML = '<i class="fas fa-equals"></i> Средний';
                    break;
                case 'low':
                    element.classList.add('priority-low');
                    element.innerHTML = '<i class="fas fa-arrow-down"></i> Низкий';
                    break;
                default:
                    element.classList.add('priority-medium');
                    element.innerHTML = '<i class="fas fa-equals"></i> Средний';
            }
        }
        
        // Проверка, просрочена ли цель
        function isOverdue(dueDateStr) {
            if (!dueDateStr) return false;
            
            const dueDate = new Date(dueDateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return dueDate < today;
        }
        
        // Форматирование даты
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
        }
        
        // Создание новой цели
        function createGoal() {
            // Сбрасываем форму
            goalForm.reset();
            document.getElementById('goal-id').value = '';
            document.getElementById('modal-title').textContent = 'Новая цель';
            
            // Устанавливаем дату (на 2 недели вперед)
            const twoWeeksLater = new Date();
            twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);
            document.getElementById('goal-due-date').value = twoWeeksLater.toISOString().split('T')[0];
            
            // Очищаем шаги
            stepsContainer.innerHTML = '';
            
            // Загружаем список курсов
            loadCourses();
            
            // Показываем форму
            goalModal.classList.add('active');
        }
        
        // Редактирование цели
        function editGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            // Заполняем форму данными цели
            document.getElementById('goal-id').value = goal.id;
            document.getElementById('goal-title').value = goal.title;
            document.getElementById('goal-description').value = goal.description || '';
            document.getElementById('goal-type').value = goal.goal_type;
            document.getElementById('goal-priority').value = goal.priority;
            
            if (goal.due_date) {
                document.getElementById('goal-due-date').value = goal.due_date;
            } else {
                document.getElementById('goal-due-date').value = '';
            }
            
            // Загружаем список курсов и выбираем нужный
            loadCourses().then(() => {
                if (goal.course) {
                    document.getElementById('goal-course').value = goal.course.id;
                } else {
                    document.getElementById('goal-course').value = '';
                }
            });
            
            // Загружаем шаги
            stepsContainer.innerHTML = '';
            if (goal.steps && goal.steps.length > 0) {
                goal.steps.forEach(step => {
                    addStep(step);
                });
            }
            
            document.getElementById('modal-title').textContent = 'Редактирование цели';
            
            // Показываем форму
            goalModal.classList.add('active');
        }
        
        // Показ подробностей цели
        function showGoalDetails(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;
            
            // Заголовок и основная информация
            document.getElementById('detail-title').textContent = goal.title;
            document.getElementById('detail-description').textContent = goal.description || 'Нет описания';
            
            // Тип цели
            document.getElementById('detail-type').textContent = getGoalTypeLabel(goal.goal_type);
            
            // Приоритет
            setPriorityBadge(document.getElementById('detail-priority'), goal.priority);
            
            // Статус
            const statusEl = document.getElementById('detail-status');
            if (goal.is_completed) {
                statusEl.textContent = 'Завершено';
                statusEl.className = 'text-sm px-3 py-1 rounded-full bg-green-100 text-green-800';
            } else if (isOverdue(goal.due_date)) {
                statusEl.textContent = 'Просрочено';
                statusEl.className = 'text-sm px-3 py-1 rounded-full bg-red-100 text-red-800';
            } else {
                statusEl.textContent = 'В процессе';
                statusEl.className = 'text-sm px-3 py-1 rounded-full bg-blue-100 text-blue-800';
            }
            
            // Срок выполнения
            document.getElementById('detail-due-date').textContent = goal.due_date ? formatDate(goal.due_date) : 'Без срока';
            
            // Прогресс
            document.getElementById('detail-progress-bar').style.width = `${goal.progress}%`;
            document.getElementById('detail-progress').textContent = `${goal.progress}%`;
            
            // Связанный курс
            const courseSection = document.getElementById('detail-course-section');
            if (goal.course) {
                courseSection.classList.remove('hidden');
                document.getElementById('detail-course-title').textContent = goal.course.title;
                document.getElementById('detail-course-link').href = `/courses/${goal.course.id}/`;
            } else {
                courseSection.classList.add('hidden');
            }
            
            // Шаги
            const stepsContainer = document.getElementById('detail-steps-container');
            stepsContainer.innerHTML = '';
            
            if (goal.steps && goal.steps.length > 0) {
                goal.steps.forEach(step => {
                    const stepEl = stepDetailTemplate.content.cloneNode(true);
                    const checkbox = stepEl.querySelector('.step-checkbox');
                    const titleLabel = stepEl.querySelector('.step-checkbox-label');
                    const titleSpan = stepEl.querySelector('.step-title');
                    
                    checkbox.id = `step-${step.id}`;
                    titleLabel.setAttribute('for', `step-${step.id}`);
                    checkbox.checked = step.is_completed;
                    titleSpan.textContent = step.title;
                    
                    if (step.description) {
                        stepEl.querySelector('.step-description').textContent = step.description;
                    } else {
                        stepEl.querySelector('.step-description').remove();
                    }
                    
                    // Если цель завершена, делаем чекбоксы неактивными
                    if (goal.is_completed) {
                        checkbox.disabled = true;
                    } else {
                        // Обработчик для изменения статуса шага
                        checkbox.addEventListener('change', function() {
                            toggleStepCompletion(goal.id, step.id, this.checked);
                        });
                    }
                    
                    stepsContainer.appendChild(stepEl);
                });
            } else {
                stepsContainer.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-sm italic">Нет шагов для этой цели</div>';
            }
            
            // Кнопка завершения/возобновления
            const completeBtn = document.getElementById('detail-complete-btn');
            if (goal.is_completed) {
                completeBtn.textContent = 'Возобновить цель';
                completeBtn.className = 'bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-1 px-4 rounded-md transition-colors text-sm';
                completeBtn.onclick = () => reopenGoal(goal.id);
            } else {
                completeBtn.textContent = 'Завершить цель';
                completeBtn.className = 'bg-green-600 hover:bg-green-700 text-white font-medium py-1 px-4 rounded-md transition-colors text-sm';
                completeBtn.onclick = () => completeGoal(goal.id);
            }
            
            // Кнопки редактирования и удаления
            document.getElementById('detail-edit-btn').onclick = () => {
                closeDetailsModal();
                editGoal(goal.id);
            };
            document.getElementById('detail-delete-btn').onclick = () => {
                if (confirm('Вы уверены, что хотите удалить эту цель?')) {
                    deleteGoal(goal.id);
                    closeDetailsModal();
                }
            };
            
            // Показываем модальное окно
            detailsModal.classList.add('active');
        }
        
        // Получение текстовой метки для типа цели
        function getGoalTypeLabel(goalType) {
            const types = {
                'course': 'Прохождение курса',
                'exam': 'Подготовка к экзамену',
                'skill': 'Изучение навыка',
                'project': 'Выполнение проекта',
                'custom': 'Другое'
            };
            return types[goalType] || 'Другое';
        }
        
        // Загрузка списка курсов
        function loadCourses() {
            return fetch('/courses/api/my/')
                .then(response => response.json())
                .then(data => {
                    const coursesSelect = document.getElementById('goal-course');
                    // Сохраняем текущее значение
                    const currentValue = coursesSelect.value;
                    
                    // Очищаем список, оставляя только первую опцию (не связан с курсом)
                    while (coursesSelect.options.length > 1) {
                        coursesSelect.remove(1);
                    }
                    
                    // Добавляем курсы
                    data.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.title;
                        coursesSelect.appendChild(option);
                    });
                    
                    // Восстанавливаем выбранное значение
                    if (currentValue) {
                        coursesSelect.value = currentValue;
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки курсов:', error);
                });
        }
        
        // Добавление шага в форму
        function addStep(stepData = null) {
            const newStep = stepTemplate.content.cloneNode(true);
            const stepItem = newStep.querySelector('.step-item');
            
            // Если есть данные шага, заполняем их
            if (stepData) {
                newStep.querySelector('[name="step_id"]').value = stepData.id || '';
                newStep.querySelector('[name="step_title"]').value = stepData.title || '';
                newStep.querySelector('[name="step_description"]').value = stepData.description || '';
            }
            
            // Обработчики кнопок
            newStep.querySelector('.remove-step').addEventListener('click', function() {
                stepItem.remove();
                updateStepOrders();
            });
            
            newStep.querySelector('.move-step-up').addEventListener('click', function() {
                const prevStep = stepItem.previousElementSibling;
                if (prevStep) {
                    stepsContainer.insertBefore(stepItem, prevStep);
                    updateStepOrders();
                }
            });
            
            newStep.querySelector('.move-step-down').addEventListener('click', function() {
                const nextStep = stepItem.nextElementSibling;
                if (nextStep) {
                    stepsContainer.insertBefore(nextStep, stepItem);
                    updateStepOrders();
                }
            });
            
            stepsContainer.appendChild(newStep);
            updateStepOrders();
        }
        
        // Обновление порядка шагов
        function updateStepOrders() {
            // При необходимости можно добавить нумерацию шагов
        }
        
        // Завершение цели
        function completeGoal(goalId) {
            fetch(`/dashboard/api/student-goals/${goalId}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ is_completed: true })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Цель успешно завершена!', 'success');
                    // Обновляем список целей
                    loadGoals();
                } else {
                    showNotification(data.message || 'Ошибка при завершении цели', 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при завершении цели:', error);
                showNotification('Произошла ошибка при завершении цели', 'error');
            });
        }
        
        // Возобновление цели
        function reopenGoal(goalId) {
            fetch(`/dashboard/api/student-goals/${goalId}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ is_completed: false })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Цель возобновлена!', 'success');
                    // Обновляем список целей
                    loadGoals();
                } else {
                    showNotification(data.message || 'Ошибка при возобновлении цели', 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при возобновлении цели:', error);
                showNotification('Произошла ошибка при возобновлении цели', 'error');
            });
        }
        
        // Изменение статуса шага
        function toggleStepCompletion(goalId, stepId, isCompleted) {
            fetch(`/dashboard/api/student-goals/${goalId}/steps/${stepId}/toggle/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ is_completed: isCompleted })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Обновляем список целей
                    loadGoals();
                } else {
                    showNotification(data.message || 'Ошибка при изменении статуса шага', 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при изменении статуса шага:', error);
                showNotification('Произошла ошибка при изменении статуса шага', 'error');
            });
        }
        
        // Удаление цели
        function deleteGoal(goalId) {
            fetch(`/dashboard/api/student-goals/${goalId}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Цель успешно удалена!', 'success');
                    // Обновляем список целей
                    loadGoals();
                } else {
                    showNotification(data.message || 'Ошибка при удалении цели', 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при удалении цели:', error);
                showNotification('Произошла ошибка при удалении цели', 'error');
            });
        }
        
        // Сохранение цели
        goalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Собираем данные формы
            const goalId = document.getElementById('goal-id').value;
            const formData = new FormData(goalForm);
            let goalData = {
                title: formData.get('title'),
                description: formData.get('description'),
                goal_type: formData.get('goal_type'),
                priority: formData.get('priority'),
                due_date: formData.get('due_date'),
                course: formData.get('course')
            };
            
            // Собираем шаги
            const steps = [];
            const stepItems = stepsContainer.querySelectorAll('.step-item');
            stepItems.forEach((item, index) => {
                steps.push({
                    id: item.querySelector('[name="step_id"]').value,
                    title: item.querySelector('[name="step_title"]').value,
                    description: item.querySelector('[name="step_description"]').value,
                    order: index + 1
                });
            });
            goalData.steps = steps;
            
            // Формируем URL и метод в зависимости от операции (создание или обновление)
            let url = '/dashboard/api/student-goals/create/';
            let method = 'POST';
            
            if (goalId) {
                url = `/dashboard/api/student-goals/${goalId}/update/`;
                method = 'PUT';
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(goalData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Цель успешно сохранена!', 'success');
                    // Обновляем список целей
                    loadGoals();
                    // Закрываем модальное окно
                    closeModals();
                } else {
                    showNotification(data.message || 'Ошибка при сохранении цели', 'error');
                }
            })
            .catch(error => {
                console.error('Ошибка при сохранении цели:', error);
                showNotification('Произошла ошибка при сохранении цели', 'error');
            });
        });
        
        // Обработчики событий
        createGoalBtn.addEventListener('click', createGoal);
        
        addStepBtn.addEventListener('click', function() {
            addStep();
        });
        
        // Обработчики для фильтров
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Удаляем класс активности со всех кнопок
                filterButtons.forEach(btn => btn.classList.remove('active'));
                
                // Добавляем класс активности к выбранной кнопке
                this.classList.add('active');
                
                // Устанавливаем текущий фильтр
                currentFilter = this.dataset.filter;
                
                // Перерисовываем список
                renderGoals();
            });
        });
        
        // Закрытие модальных окон
        function closeModals() {
            goalModal.classList.remove('active');
            detailsModal.classList.remove('active');
        }
        
        function closeDetailsModal() {
            detailsModal.classList.remove('active');
        }
        
        document.getElementById('close-modal').addEventListener('click', closeModals);
        document.getElementById('cancel-goal').addEventListener('click', closeModals);
        document.getElementById('close-details-modal').addEventListener('click', closeDetailsModal);
        
        // Закрытие при клике вне модального окна
        window.addEventListener('click', function(e) {
            if (e.target === goalModal) {
                closeModals();
            }
            if (e.target === detailsModal) {
                closeDetailsModal();
            }
        });
        
        // Получение CSRF-токена
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            return cookieValue;
        }
        
        // Функция showNotification теперь импортирована из notifications.js
        
        // Загрузка данных при загрузке страницы
        loadGoals();
    });
</script>
{% endblock %}