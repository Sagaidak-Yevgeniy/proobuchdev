{% extends 'base.html' %}

{% block title %}Мероприятия - ПроОбучение{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .event-card {
        transition: all 0.3s ease;
    }
    .event-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .event-badge {
        font-size: 0.7rem;
        padding: 0.15rem 0.5rem;
        border-radius: 1rem;
    }
    /* Стили для разных типов мероприятий */
    .event-webinar {
        background-color: rgba(99, 102, 241, 0.1);
        color: rgb(79, 70, 229);
        border: 1px solid rgba(99, 102, 241, 0.3);
    }
    .event-lecture {
        background-color: rgba(6, 182, 212, 0.1);
        color: rgb(6, 182, 212);
        border: 1px solid rgba(6, 182, 212, 0.3);
    }
    .event-seminar {
        background-color: rgba(16, 185, 129, 0.1);
        color: rgb(16, 185, 129);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .event-consultation {
        background-color: rgba(245, 158, 11, 0.1);
        color: rgb(245, 158, 11);
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .event-deadline {
        background-color: rgba(239, 68, 68, 0.1);
        color: rgb(239, 68, 68);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .event-other {
        background-color: rgba(107, 114, 128, 0.1);
        color: rgb(107, 114, 128);
        border: 1px solid rgba(107, 114, 128, 0.3);
    }
    /* Стили для состояний мероприятий */
    .event-past {
        opacity: 0.7;
    }
    .event-ongoing {
        border-left: 3px solid #10b981;
    }
    .event-upcoming {
        border-left: 3px solid #3b82f6;
    }
    .create-event-btn {
        transition: all 0.3s ease;
    }
    .create-event-btn:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row items-center justify-between mb-8">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-4 md:mb-0">Мероприятия</h1>
        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 w-full md:w-auto">
            <button id="createEventBtn" class="create-event-btn bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                <i class="fas fa-plus mr-2"></i> Создать мероприятие
            </button>
            <div class="relative">
                <select id="eventTypeFilter" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-lg py-2 pl-3 pr-10 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="all">Все типы</option>
                    <option value="webinar">Вебинары</option>
                    <option value="lecture">Лекции</option>
                    <option value="seminar">Семинары</option>
                    <option value="consultation">Консультации</option>
                    <option value="deadline">Дедлайны</option>
                    <option value="other">Другое</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="relative">
                <select id="eventPeriodFilter" class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-lg py-2 pl-3 pr-10 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="upcoming">Предстоящие</option>
                    <option value="all">Все мероприятия</option>
                    <option value="past">Прошедшие</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-200">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Поиск мероприятий -->
    <div class="mb-6">
        <div class="relative">
            <input type="text" id="eventSearch" placeholder="Поиск мероприятий..." class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
            </div>
        </div>
    </div>

    <!-- Список мероприятий -->
    <div id="eventsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Здесь будут отображаться карточки мероприятий -->
        <div class="col-span-full text-center py-8">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
            <p class="text-gray-600 dark:text-gray-300 text-lg">Загрузка мероприятий...</p>
        </div>
    </div>

    <!-- Пагинация -->
    <div id="eventsPagination" class="flex justify-center mt-8 space-x-2 hidden">
        <button id="prevPageBtn" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 disabled:opacity-50">
            <i class="fas fa-chevron-left mr-1"></i> Назад
        </button>
        <div id="paginationInfo" class="px-4 py-2 text-gray-700 dark:text-gray-200">
            Страница <span id="currentPage">1</span> из <span id="totalPages">1</span>
        </div>
        <button id="nextPageBtn" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 disabled:opacity-50">
            Вперед <i class="fas fa-chevron-right ml-1"></i>
        </button>
    </div>

    <!-- Модальное окно для создания/редактирования мероприятия -->
    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4 overflow-hidden">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Создание мероприятия</h3>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <form id="eventForm">
                    <input type="hidden" id="eventId" name="eventId" value="">
                    <div class="mb-4">
                        <label for="eventTitle" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Название мероприятия*</label>
                        <input type="text" id="eventTitle" name="title" required class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700 dark:text-gray-200">
                    </div>
                    <div class="mb-4">
                        <label for="eventDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Описание</label>
                        <textarea id="eventDescription" name="description" rows="3" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700 dark:text-gray-200"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="eventType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Тип мероприятия*</label>
                            <select id="eventType" name="event_type" required class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700 dark:text-gray-200">
                                <option value="webinar">Вебинар</option>
                                <option value="lecture">Лекция</option>
                                <option value="seminar">Семинар</option>
                                <option value="consultation">Консультация</option>
                                <option value="deadline">Дедлайн</option>
                                <option value="other">Другое</option>
                            </select>
                        </div>
                        <div>
                            <label for="eventCourse" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Курс (необязательно)</label>
                            <select id="eventCourse" name="course_id" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700 dark:text-gray-200">
                                <option value="">Не привязан к курсу</option>
                                <!-- Здесь будут варианты курсов -->
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="eventStartTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Время начала*</label>
                            <input type="text" id="eventStartTime" name="start_time" required class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700 dark:text-gray-200">
                        </div>
                        <div>
                            <label for="eventEndTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Время окончания*</label>
                            <input type="text" id="eventEndTime" name="end_time" required class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700 dark:text-gray-200">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="eventLocation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Место проведения</label>
                            <input type="text" id="eventLocation" name="location" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700 dark:text-gray-200">
                        </div>
                        <div>
                            <label for="eventUrl" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ссылка на мероприятие</label>
                            <input type="url" id="eventUrl" name="url" placeholder="https://" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700 dark:text-gray-200">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="eventMaxParticipants" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Макс. количество участников</label>
                            <input type="number" id="eventMaxParticipants" name="max_participants" min="0" value="0" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-700 dark:text-gray-200">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">0 - без ограничений</p>
                        </div>
                        <div class="flex items-center">
                            <label class="flex items-center cursor-pointer mt-6">
                                <div class="relative">
                                    <input type="checkbox" id="eventIsPublic" name="is_public" checked class="sr-only">
                                    <div class="block bg-gray-300 dark:bg-gray-600 w-10 h-6 rounded-full"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                                <div class="ml-3 text-gray-700 dark:text-gray-300 font-medium">
                                    Публичное мероприятие
                                </div>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-3">
                <button id="cancelEventBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-lg font-medium">Отмена</button>
                <button id="saveEventBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра деталей мероприятия -->
    <div id="eventDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl mx-4 overflow-hidden">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center">
                    <h3 id="detailsModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Детали мероприятия</h3>
                    <button id="closeDetailsModalBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="eventDetailsContent" class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Здесь будут отображаться детали мероприятия -->
                <div class="animate-pulse">
                    <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-4"></div>
                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-full mb-3"></div>
                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-full mb-3"></div>
                    <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-2/3 mb-6"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="h-10 bg-gray-200 dark:bg-gray-700 rounded"></div>
                        <div class="h-10 bg-gray-200 dark:bg-gray-700 rounded"></div>
                    </div>
                </div>
            </div>
            <div id="eventDetailsActions" class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-between">
                <div>
                    <button id="editEventBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium hidden">
                        <i class="fas fa-edit mr-2"></i> Редактировать
                    </button>
                    <button id="deleteEventBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium ml-2 hidden">
                        <i class="fas fa-trash-alt mr-2"></i> Удалить
                    </button>
                </div>
                <div>
                    <button id="registerEventBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium hidden">
                        <i class="fas fa-user-plus mr-2"></i> Зарегистрироваться
                    </button>
                    <button id="cancelRegistrationBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium hidden">
                        <i class="fas fa-user-minus mr-2"></i> Отменить регистрацию
                    </button>
                    <button id="closeDetailsBtn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-lg font-medium">
                        Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
<script>
    // Инициализация выбора даты и времени
    flatpickr("#eventStartTime", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        locale: "ru",
        time_24hr: true,
        minDate: "today"
    });
    
    flatpickr("#eventEndTime", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        locale: "ru",
        time_24hr: true,
        minDate: "today"
    });
    
    // Загрузка мероприятий при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Переключатель для публичного мероприятия
        const toggleSwitch = document.getElementById('eventIsPublic');
        const dot = document.querySelector('.dot');
        
        toggleSwitch.addEventListener('change', function() {
            if (this.checked) {
                dot.classList.add('transform', 'translate-x-4');
            } else {
                dot.classList.remove('transform', 'translate-x-4');
            }
        });
        
        // Загрузка списка курсов для выбора
        fetch('/dashboard/api/courses-progress/')
            .then(response => response.json())
            .then(data => {
                const courseSelect = document.getElementById('eventCourse');
                data.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.title;
                    courseSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Ошибка загрузки курсов:', error));
        
        // Загрузка списка мероприятий
        loadEvents();
        
        // Обработчики событий для фильтров
        document.getElementById('eventTypeFilter').addEventListener('change', loadEvents);
        document.getElementById('eventPeriodFilter').addEventListener('change', loadEvents);
        document.getElementById('eventSearch').addEventListener('input', debounce(loadEvents, 300));
        
        // Обработчики для модального окна создания мероприятия
        document.getElementById('createEventBtn').addEventListener('click', openCreateEventModal);
        document.getElementById('closeModalBtn').addEventListener('click', closeEventModal);
        document.getElementById('cancelEventBtn').addEventListener('click', closeEventModal);
        document.getElementById('saveEventBtn').addEventListener('click', saveEvent);
        
        // Обработчики для модального окна просмотра деталей
        document.getElementById('closeDetailsModalBtn').addEventListener('click', closeDetailsModal);
        document.getElementById('closeDetailsBtn').addEventListener('click', closeDetailsModal);
    });
    
    // Функция загрузки мероприятий с учетом фильтров
    function loadEvents() {
        const eventsContainer = document.getElementById('eventsContainer');
        const typeFilter = document.getElementById('eventTypeFilter').value;
        const periodFilter = document.getElementById('eventPeriodFilter').value;
        const searchQuery = document.getElementById('eventSearch').value;
        
        // Показываем индикатор загрузки
        eventsContainer.innerHTML = `
            <div class="col-span-full text-center py-8">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
                <p class="text-gray-600 dark:text-gray-300 text-lg">Загрузка мероприятий...</p>
            </div>
        `;
        
        // Строим URL с параметрами фильтрации
        let url = '/dashboard/api/events/';
        const params = new URLSearchParams();
        if (typeFilter !== 'all') params.append('type', typeFilter);
        if (periodFilter !== 'all') params.append('period', periodFilter);
        if (searchQuery) params.append('search', searchQuery);
        if (params.toString()) url += '?' + params.toString();
        
        // Получаем мероприятия
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.events.length === 0) {
                    eventsContainer.innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <i class="far fa-calendar-times text-5xl text-gray-400 dark:text-gray-600 mb-4"></i>
                            <p class="text-gray-600 dark:text-gray-300 text-lg mb-2">Мероприятия не найдены</p>
                            <p class="text-gray-500 dark:text-gray-400">Попробуйте изменить параметры фильтрации или создайте новое мероприятие</p>
                        </div>
                    `;
                } else {
                    eventsContainer.innerHTML = data.events.map(event => createEventCard(event)).join('');
                    
                    // Добавляем обработчики для карточек мероприятий
                    document.querySelectorAll('.event-card').forEach(card => {
                        card.addEventListener('click', function() {
                            const eventId = this.dataset.eventId;
                            openEventDetails(eventId);
                        });
                    });
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки мероприятий:', error);
                eventsContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-300 text-lg mb-2">Ошибка загрузки мероприятий</p>
                        <p class="text-gray-500 dark:text-gray-400">Пожалуйста, попробуйте обновить страницу</p>
                    </div>
                `;
            });
    }
    
    // Функция создания карточки мероприятия
    function createEventCard(event) {
        const statusClass = event.is_past ? 'event-past' : (event.is_ongoing ? 'event-ongoing' : 'event-upcoming');
        const eventTypeClass = `event-${event.event_type}`;
        
        const statusBadge = event.is_past 
            ? '<span class="event-badge bg-gray-100 text-gray-600 border border-gray-300">Прошедшее</span>'
            : (event.is_ongoing 
                ? '<span class="event-badge bg-green-100 text-green-700 border border-green-300">Идет сейчас</span>'
                : '<span class="event-badge bg-blue-100 text-blue-700 border border-blue-300">Предстоящее</span>');
                
        const registrationBadge = event.is_registered
            ? '<span class="event-badge bg-indigo-100 text-indigo-700 border border-indigo-300">Вы зарегистрированы</span>'
            : '';
            
        const ownerBadge = event.is_owner
            ? '<span class="event-badge bg-purple-100 text-purple-700 border border-purple-300">Организатор</span>'
            : '';
            
        const formatDateTime = (dateTime) => {
            const date = new Date(dateTime);
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };
        
        return `
            <div class="event-card ${statusClass} cursor-pointer bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden" data-event-id="${event.id}">
                <div class="p-5">
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="event-badge ${eventTypeClass}">${event.event_type_display}</span>
                        ${statusBadge}
                        ${registrationBadge}
                        ${ownerBadge}
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2 line-clamp-2">${event.title}</h3>
                    <p class="text-gray-600 dark:text-gray-300 text-sm mb-3 line-clamp-2">${event.description || 'Нет описания'}</p>
                    <div class="flex items-center mb-2 text-sm">
                        <i class="far fa-clock text-gray-500 dark:text-gray-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">${formatDateTime(event.start_time)}</span>
                    </div>
                    ${event.location ? `
                    <div class="flex items-center mb-2 text-sm">
                        <i class="fas fa-map-marker-alt text-gray-500 dark:text-gray-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">${event.location}</span>
                    </div>
                    ` : ''}
                    ${event.course ? `
                    <div class="flex items-center mb-2 text-sm">
                        <i class="fas fa-book text-gray-500 dark:text-gray-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">${event.course.title}</span>
                    </div>
                    ` : ''}
                    <div class="flex items-center text-sm">
                        <i class="fas fa-users text-gray-500 dark:text-gray-400 mr-2"></i>
                        <span class="text-gray-700 dark:text-gray-300">
                            ${event.participants_count} ${getParticipantsText(event.participants_count)}
                            ${event.max_participants > 0 ? ` из ${event.max_participants}` : ''}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Функция для склонения слова "участник"
    function getParticipantsText(count) {
        const lastDigit = count % 10;
        const lastTwoDigits = count % 100;
        
        if (lastTwoDigits >= 11 && lastTwoDigits <= 19) {
            return 'участников';
        }
        
        if (lastDigit === 1) {
            return 'участник';
        }
        
        if (lastDigit >= 2 && lastDigit <= 4) {
            return 'участника';
        }
        
        return 'участников';
    }
    
    // Функция открытия модального окна для создания мероприятия
    function openCreateEventModal() {
        // Сбрасываем форму
        document.getElementById('eventForm').reset();
        document.getElementById('eventId').value = '';
        document.getElementById('modalTitle').textContent = 'Создание мероприятия';
        
        // Устанавливаем значения по умолчанию
        const now = new Date();
        const startTime = new Date(now.getTime() + 3600000); // +1 час
        const endTime = new Date(now.getTime() + 7200000); // +2 часа
        
        // Форматируем даты для flatpickr
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        };
        
        document.getElementById('eventStartTime')._flatpickr.setDate(formatDate(startTime));
        document.getElementById('eventEndTime')._flatpickr.setDate(formatDate(endTime));
        
        // Показываем модальное окно
        document.getElementById('eventModal').classList.remove('hidden');
    }
    
    // Функция закрытия модального окна
    function closeEventModal() {
        document.getElementById('eventModal').classList.add('hidden');
    }
    
    // Функция сохранения мероприятия
    function saveEvent() {
        const form = document.getElementById('eventForm');
        const eventId = document.getElementById('eventId').value;
        
        // Проверяем валидность формы
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Собираем данные из формы
        const formData = {
            title: document.getElementById('eventTitle').value,
            description: document.getElementById('eventDescription').value,
            event_type: document.getElementById('eventType').value,
            start_time: document.getElementById('eventStartTime').value,
            end_time: document.getElementById('eventEndTime').value,
            location: document.getElementById('eventLocation').value,
            url: document.getElementById('eventUrl').value,
            max_participants: parseInt(document.getElementById('eventMaxParticipants').value, 10),
            is_public: document.getElementById('eventIsPublic').checked,
            course_id: document.getElementById('eventCourse').value || null
        };
        
        // Определяем URL и метод в зависимости от режима (создание или редактирование)
        const url = eventId 
            ? `/dashboard/api/events/${eventId}/update/` 
            : '/dashboard/api/events/create/';
        
        // Отправляем запрос
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно и обновляем список мероприятий
                closeEventModal();
                loadEvents();
                
                // Показываем уведомление об успехе
                showNotification(
                    eventId ? 'Мероприятие обновлено' : 'Мероприятие создано',
                    'success'
                );
            } else {
                // Показываем уведомление об ошибке
                showNotification(
                    `Ошибка: ${data.error || 'Не удалось сохранить мероприятие'}`,
                    'error'
                );
            }
        })
        .catch(error => {
            console.error('Ошибка сохранения мероприятия:', error);
            showNotification(
                'Произошла ошибка при сохранении мероприятия',
                'error'
            );
        });
    }
    
    // Функция открытия деталей мероприятия
    function openEventDetails(eventId) {
        const detailsModal = document.getElementById('eventDetailsModal');
        const detailsContent = document.getElementById('eventDetailsContent');
        
        // Показываем индикатор загрузки
        detailsContent.innerHTML = `
            <div class="animate-pulse">
                <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-4"></div>
                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-full mb-3"></div>
                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-full mb-3"></div>
                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-2/3 mb-6"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="h-10 bg-gray-200 dark:bg-gray-700 rounded"></div>
                    <div class="h-10 bg-gray-200 dark:bg-gray-700 rounded"></div>
                </div>
            </div>
        `;
        
        // Скрываем все кнопки
        document.getElementById('editEventBtn').classList.add('hidden');
        document.getElementById('deleteEventBtn').classList.add('hidden');
        document.getElementById('registerEventBtn').classList.add('hidden');
        document.getElementById('cancelRegistrationBtn').classList.add('hidden');
        
        // Показываем модальное окно
        detailsModal.classList.remove('hidden');
        
        // Загружаем данные мероприятия
        fetch(`/dashboard/api/events/${eventId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const event = data.event;
                    
                    // Обновляем заголовок модального окна
                    document.getElementById('detailsModalTitle').textContent = event.title;
                    
                    // Форматируем даты
                    const formatDate = (dateString) => {
                        const date = new Date(dateString);
                        return date.toLocaleString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    };
                    
                    // Определяем статус мероприятия
                    let statusBadge = '';
                    if (event.is_past) {
                        statusBadge = '<span class="inline-block px-2 py-1 rounded-full bg-gray-100 text-gray-600 text-xs font-medium mr-2">Прошедшее</span>';
                    } else if (event.is_ongoing) {
                        statusBadge = '<span class="inline-block px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs font-medium mr-2">Идет сейчас</span>';
                    } else {
                        statusBadge = '<span class="inline-block px-2 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-medium mr-2">Предстоящее</span>';
                    }
                    
                    // Создаем HTML с деталями мероприятия
                    const eventDetailsHTML = `
                        <div class="mb-6">
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span class="inline-block px-2 py-1 rounded-full event-${event.event_type} text-xs font-medium">${event.event_type_display}</span>
                                ${statusBadge}
                                ${event.is_full ? '<span class="inline-block px-2 py-1 rounded-full bg-red-100 text-red-700 text-xs font-medium">Мест нет</span>' : ''}
                            </div>
                            <p class="text-gray-700 dark:text-gray-300 mb-6">${event.description || 'Описание отсутствует'}</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="flex items-start">
                                    <i class="far fa-clock text-gray-500 dark:text-gray-400 mt-1 mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Время начала</p>
                                        <p class="text-gray-800 dark:text-gray-200">${formatDate(event.start_time)}</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <i class="far fa-clock text-gray-500 dark:text-gray-400 mt-1 mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Время окончания</p>
                                        <p class="text-gray-800 dark:text-gray-200">${formatDate(event.end_time)}</p>
                                    </div>
                                </div>
                            </div>
                            ${event.location ? `
                            <div class="flex items-start mb-4">
                                <i class="fas fa-map-marker-alt text-gray-500 dark:text-gray-400 mt-1 mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Место проведения</p>
                                    <p class="text-gray-800 dark:text-gray-200">${event.location}</p>
                                </div>
                            </div>
                            ` : ''}
                            ${event.url ? `
                            <div class="flex items-start mb-4">
                                <i class="fas fa-link text-gray-500 dark:text-gray-400 mt-1 mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Ссылка на мероприятие</p>
                                    <a href="${event.url}" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">${event.url}</a>
                                </div>
                            </div>
                            ` : ''}
                            ${event.course ? `
                            <div class="flex items-start mb-4">
                                <i class="fas fa-book text-gray-500 dark:text-gray-400 mt-1 mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Связанный курс</p>
                                    <a href="/courses/${event.course.slug}/" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">${event.course.title}</a>
                                </div>
                            </div>
                            ` : ''}
                            <div class="flex items-start mb-4">
                                <i class="fas fa-users text-gray-500 dark:text-gray-400 mt-1 mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Участники</p>
                                    <p class="text-gray-800 dark:text-gray-200">
                                        ${event.participants_count} ${getParticipantsText(event.participants_count)}
                                        ${event.max_participants > 0 ? ` из ${event.max_participants}` : ''}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-user text-gray-500 dark:text-gray-400 mt-1 mr-3"></i>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Организатор</p>
                                    <p class="text-gray-800 dark:text-gray-200">${event.created_by.full_name}</p>
                                </div>
                            </div>
                        </div>
                        
                        ${event.participants && event.participants.length > 0 ? `
                        <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Список участников</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${event.participants.map(p => `
                                <div class="bg-gray-50 dark:bg-gray-750 rounded-lg p-3 flex items-center">
                                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-300 mr-3">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800 dark:text-gray-200">${p.full_name}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">
                                            ${p.status_display} · ${formatDate(p.registered_at)}
                                        </p>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    `;
                    
                    // Обновляем содержимое модального окна
                    detailsContent.innerHTML = eventDetailsHTML;
                    
                    // Показываем соответствующие кнопки
                    if (event.is_owner) {
                        document.getElementById('editEventBtn').classList.remove('hidden');
                        document.getElementById('deleteEventBtn').classList.remove('hidden');
                        
                        // Добавляем обработчики для кнопок редактирования и удаления
                        document.getElementById('editEventBtn').onclick = () => {
                            closeDetailsModal();
                            openEditEventModal(event);
                        };
                        
                        document.getElementById('deleteEventBtn').onclick = () => {
                            if (confirm('Вы уверены, что хотите удалить это мероприятие?')) {
                                deleteEvent(event.id);
                            }
                        };
                    }
                    
                    // Для незарегистрированных пользователей показываем кнопку регистрации
                    if (!event.is_owner && !event.is_registered && !event.is_past && !event.is_full) {
                        document.getElementById('registerEventBtn').classList.remove('hidden');
                        document.getElementById('registerEventBtn').onclick = () => registerForEvent(event.id);
                    }
                    
                    // Для зарегистрированных пользователей показываем кнопку отмены регистрации
                    if (!event.is_owner && event.is_registered && !event.is_past) {
                        document.getElementById('cancelRegistrationBtn').classList.remove('hidden');
                        document.getElementById('cancelRegistrationBtn').onclick = () => cancelRegistration(event.id);
                    }
                } else {
                    detailsContent.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                            <p class="text-gray-600 dark:text-gray-300 text-lg mb-2">Ошибка загрузки данных</p>
                            <p class="text-gray-500 dark:text-gray-400">${data.error || 'Не удалось загрузить данные мероприятия'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки деталей мероприятия:', error);
                detailsContent.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                        <p class="text-gray-600 dark:text-gray-300 text-lg mb-2">Ошибка загрузки данных</p>
                        <p class="text-gray-500 dark:text-gray-400">Произошла ошибка при загрузке деталей мероприятия</p>
                    </div>
                `;
            });
    }
    
    // Функция закрытия модального окна с деталями
    function closeDetailsModal() {
        document.getElementById('eventDetailsModal').classList.add('hidden');
    }
    
    // Функция открытия модального окна для редактирования мероприятия
    function openEditEventModal(event) {
        // Заполняем форму данными мероприятия
        document.getElementById('eventId').value = event.id;
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventDescription').value = event.description || '';
        document.getElementById('eventType').value = event.event_type;
        document.getElementById('eventLocation').value = event.location || '';
        document.getElementById('eventUrl').value = event.url || '';
        document.getElementById('eventMaxParticipants').value = event.max_participants;
        document.getElementById('eventIsPublic').checked = event.is_public;
        
        // Обновляем состояние переключателя
        const dot = document.querySelector('.dot');
        if (event.is_public) {
            dot.classList.add('transform', 'translate-x-4');
        } else {
            dot.classList.remove('transform', 'translate-x-4');
        }
        
        // Устанавливаем время начала и окончания
        document.getElementById('eventStartTime')._flatpickr.setDate(event.start_time);
        document.getElementById('eventEndTime')._flatpickr.setDate(event.end_time);
        
        // Выбираем курс, если он указан
        if (event.course) {
            document.getElementById('eventCourse').value = event.course.id;
        } else {
            document.getElementById('eventCourse').value = '';
        }
        
        // Обновляем заголовок модального окна
        document.getElementById('modalTitle').textContent = 'Редактирование мероприятия';
        
        // Показываем модальное окно
        document.getElementById('eventModal').classList.remove('hidden');
    }
    
    // Функция удаления мероприятия
    function deleteEvent(eventId) {
        fetch(`/dashboard/api/events/${eventId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно деталей и обновляем список мероприятий
                closeDetailsModal();
                loadEvents();
                
                // Показываем уведомление об успехе
                showNotification('Мероприятие удалено', 'success');
            } else {
                // Показываем уведомление об ошибке
                showNotification(`Ошибка: ${data.error || 'Не удалось удалить мероприятие'}`, 'error');
            }
        })
        .catch(error => {
            console.error('Ошибка удаления мероприятия:', error);
            showNotification('Произошла ошибка при удалении мероприятия', 'error');
        });
    }
    
    // Функция регистрации на мероприятие
    function registerForEvent(eventId) {
        fetch(`/dashboard/api/events/${eventId}/register/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно деталей и обновляем список мероприятий
                closeDetailsModal();
                loadEvents();
                
                // Показываем уведомление об успехе
                showNotification('Вы успешно зарегистрированы на мероприятие', 'success');
            } else {
                // Показываем уведомление об ошибке
                showNotification(`Ошибка: ${data.error || 'Не удалось зарегистрироваться на мероприятие'}`, 'error');
            }
        })
        .catch(error => {
            console.error('Ошибка регистрации на мероприятие:', error);
            showNotification('Произошла ошибка при регистрации на мероприятие', 'error');
        });
    }
    
    // Функция отмены регистрации на мероприятие
    function cancelRegistration(eventId) {
        fetch(`/dashboard/api/events/${eventId}/cancel/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно деталей и обновляем список мероприятий
                closeDetailsModal();
                loadEvents();
                
                // Показываем уведомление об успехе
                showNotification('Регистрация на мероприятие отменена', 'success');
            } else {
                // Показываем уведомление об ошибке
                showNotification(`Ошибка: ${data.error || 'Не удалось отменить регистрацию'}`, 'error');
            }
        })
        .catch(error => {
            console.error('Ошибка отмены регистрации:', error);
            showNotification('Произошла ошибка при отмене регистрации', 'error');
        });
    }
    
    // Вспомогательная функция для получения CSRF-токена из cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Функция для отображения уведомлений
    function showNotification(message, type = 'info') {
        // Создаем элемент уведомления
        const notification = document.createElement('div');
        notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-full opacity-0 ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        // Добавляем на страницу
        document.body.appendChild(notification);
        
        // Показываем с анимацией
        setTimeout(() => {
            notification.classList.remove('translate-y-full', 'opacity-0');
        }, 10);
        
        // Скрываем через 3 секунды
        setTimeout(() => {
            notification.classList.add('translate-y-full', 'opacity-0');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
    
    // Функция для задержки выполнения (debounce)
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                func.apply(context, args);
            }, wait);
        };
    }
</script>
{% endblock %}